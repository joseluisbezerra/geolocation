{% extends 'base.html' %}
{% load leaflet_tags %}

{% block title %}Geolocation{% endblock %}

{% block javascript %}
    <script>
        var pins_url = '{% url "pins_list" %}';

        window.addEventListener("map:init", function (event) {
            var map = event.detail.map;

            fetch(pins_url)
                .then(function(resp) {
                    return resp.json();
                })
                .then(function(data) {
                    for (var i = 0; i < data.length; i++){
                        var pin = data[i];
                        
                        var content = document.createElement("div");
                        content.className = "pin";

                        var paragraph = document.createElement("p");

                        var title = document.createElement("strong");
                        title.innerHTML = `${pin.name}`;

                        paragraph.appendChild(title);

                        var description = document.createElement("em");
                        description.innerHTML = `Expiration date: ${pin.expiration_date}`;

                        paragraph.appendChild(description);

                        content.appendChild(paragraph);

                        var button_delete = document.createElement("a");
                        button_delete.innerHTML = "Delete pin";
                        button_delete.className = "btn btn-danger btn-sm";
                        button_delete.href = `{% url "delete_pin" id=1 %}`.replace('1', pin.id);

                        content.appendChild(button_delete)

                        var pin_location = JSON.parse(pin.pin_location);

                        L.marker(pin_location.coordinates.reverse()).addTo(map)
                            .bindPopup(content)
                            .openPopup();
                    }
                });
        });
  </script>
{% endblock %}

{% block content %}
    <h1>Pins</h1>

    {% if messages %}
      <ul class="messages">
          {% for message in messages %}
              <li {% if message.tags %}class='alert alert-{{ message.tags }}'{% endif %}>{{ message }}</li>
          {% endfor %}
      </ul>
    {% endif %}

    {% leaflet_map "map" %}
{% endblock %}
